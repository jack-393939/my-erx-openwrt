name: OpenWrt Builder

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set timezone
        run: sudo timedatectl set-timezone "$TZ"

      - name: Initialization environment
        run: |
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get update -yq --fix-missing
          sudo apt-get install -yq --no-install-recommends --fix-broken \
            build-essential subversion git-core libncurses5-dev zlib1g-dev \
            gawk flex quilt libssl-dev xsltproc libxml-parser-perl unzip \
            python3 python3-setuptools rsync wget curl file bc time \
            gettext pkg-config libelf-dev libglib2.0-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            patch bzip2 tar xz-utils make gcc g++ ccache \
            cmake ninja-build libdeflate-dev libzstd-dev

      - name: Clone source code
        run: |
          mkdir -p openwrt
          cd openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL . || { echo "git clone failed"; exit 1; }
          pwd
          ls -la

      - name: Build host tools first
        run: |
          cd openwrt
          # 先构建工具链，避免 libdeflate-gzip 等缺失
          make tools/install -j1 V=s DEBUG=1 || { echo "tools/install failed"; tail -n 50 $(find logs -type f 2>/dev/null || echo "no logs"); exit 1; }
          make toolchain/install -j1 V=s DEBUG=1 || { echo "toolchain/install failed"; tail -n 50 $(find logs -type f 2>/dev/null || echo "no logs"); exit 1; }
          ls -la staging_dir/host/bin/ | grep -E "libdeflate-gzip|ninja" || echo "Key host tools missing!"

      - name: Copy and use existing .config
        run: |
          cd openwrt
          if [ -f ../.config ]; then
            cp ../.config .config
            echo ".config copied from repository"
          else
            echo ".config not found in repository!"
            exit 1
          fi
          cat .config | grep -E "CONFIG_TARGET_ramips|DEVICE_ubnt_erx" || echo "Target config missing in .config"

      - name: Load custom feeds and diy-part1
        run: |
          cd openwrt
          if [ -f ../feeds.conf.default ]; then mv ../feeds.conf.default feeds.conf.default; fi
          if [ -f ../diy-part1.sh ]; then chmod +x ../diy-part1.sh && ../diy-part1.sh || echo "diy-part1 failed"; fi

      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a || echo "feeds update failed"
          ./scripts/feeds install -a || echo "feeds install failed"

      - name: Apply configuration and build
        run: |
          cd openwrt
          make defconfig || { echo "defconfig failed"; exit 1; }
          make -j4 package/compile V=s || make -j1 package/compile V=s
          make -j4 target/install V=s || make -j1 target/install V=s
          make -j4 image V=s || make -j1 image V=s DEBUG=1

      - name: Upload firmware artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware
          path: openwrt/bin/targets/**/*
          if-no-files-found: warn

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: openwrt/logs/**/*
          if-no-files-found: warn
