name: OpenWrt Builder

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest  # 自动用最新 Ubuntu (24.04+)

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization environment
      run: |
        sudo apt-get update -yq  # 强制安静更新 cache
        sudo apt-get upgrade -yq
        sudo apt-get install -yq build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3-setuptools rsync subversion unzip zlib1g-dev wget curl \
        cmake ninja-build pkgconf texinfo help2man libtool libtool-bin \
        device-tree-compiler bc ccache ecj fastjar python3-distutils \
        python3-dev swig xsltproc file gperf haveged patch quilt \
        libglib2.0-dev libelf-dev libmpc-dev libmpfr-dev libgmp3-dev \
        libzstd-dev liblzma-dev

    - name: Clone source code
      run: |
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt

    - name: Load custom feeds and diy-part1
      run: |
        cd openwrt
        if [ -f ../feeds.conf.default ]; then mv ../feeds.conf.default feeds.conf.default; fi
        if [ -f ../diy-part1.sh ]; then chmod +x ../diy-part1.sh; ../diy-part1.sh; fi

    - name: Update and install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a || true  # 容错
        ./scripts/feeds install -a

    - name: Load custom configuration and diy-part2
      run: |
        cd openwrt
        if [ -f ../.config ]; then mv ../.config .config; fi
        if [ -f ../diy-part2.sh ]; then chmod +x ../diy-part2.sh; ../diy-part2.sh; fi
        make defconfig

    - name: Download packages
      run: |
        cd openwrt
        make download -j8 || make download -j1 || true

    - name: Compile firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s || make -j1 V=s
