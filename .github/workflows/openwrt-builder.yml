name: OpenWrt Builder

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set timezone
        run: sudo timedatectl set-timezone "$TZ"

      - name: Initialization environment
        run: |
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get update -yq --fix-missing
          sudo apt-get install -yq --no-install-recommends --fix-broken \
            build-essential subversion git-core libncurses5-dev zlib1g-dev \
            gawk flex quilt libssl-dev xsltproc libxml-parser-perl unzip \
            python3 python3-setuptools rsync wget curl file bc time \
            gettext pkg-config libelf-dev libglib2.0-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            patch bzip2 tar xz-utils make gcc g++ ccache ninja-build

      - name: Clone source code
        run: |
          mkdir -p openwrt
          cd openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL . || { echo "git clone failed"; exit 1; }
          pwd
          ls -la

      - name: Build host tools and toolchain first
        run: |
          cd openwrt
          echo "Current directory: $(pwd)"
          ls -la
          make tools/install -j1 V=s DEBUG=1 || { echo "tools/install failed with code $?"; exit 1; }
          make toolchain/install -j1 V=s DEBUG=1 || { echo "toolchain/install failed with code $?"; exit 1; }
          ls -la staging_dir/host/bin/  # 检查 libdeflate-gzip 是否生成
          which libdeflate-gzip || echo "libdeflate-gzip not found"

      - name: Load custom feeds and diy-part1
        run: |
          cd openwrt
          if [ -f ../feeds.conf.default ]; then mv ../feeds.conf.default feeds.conf.default; fi
          if [ -f ../diy-part1.sh ]; then
            chmod +x ../diy-part1.sh
            ../diy-part1.sh || echo "diy-part1 failed"
          fi

      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a || echo "feeds update failed"
          ./scripts/feeds install -a || echo "feeds install failed"

      - name: Load custom configuration and diy-part2
        run: |
          cd openwrt
          if [ -f ../.config ]; then mv ../.config .config; fi
          if [ -d ../files ]; then mv ../files files; fi
          if [ -f ../diy-part2.sh ]; then
            chmod +x ../diy-part2.sh
            ../diy-part2.sh || echo "diy-part2 failed"
          fi
          make defconfig || echo "defconfig failed"

      - name: Build packages and image
        run: |
          cd openwrt
          make -j4 package/compile V=s || make -j1 package/compile V=s
          make -j4 target/install V=s || make -j1 target/install V=s
          make -j4 image V=s || make -j1 image V=s DEBUG=1

      - name: Upload firmware artifacts (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware
          path: openwrt/bin/targets/**/*
          if-no-files-found: warn

      - name: Upload build logs for debug
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: openwrt/logs/**/*
          if-no-files-found: warn
